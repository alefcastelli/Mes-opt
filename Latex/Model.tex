\documentclass{article}
%
\usepackage{fullpage}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{eurosym}
\usepackage{verbatim}

\usepackage{IEEEtrantools}
\usepackage{filecontents}


\newcommand{\cT}{{\mathcal T}}
\newcommand{\cM}{{\mathcal M}}
\newcommand{\cP}{{\mathcal P}}
\newcommand{\cQ}{{\mathcal Q}}
\newcommand{\cC}{{\mathcal C}}
\newcommand{\cF}{{\mathcal F}}
\newcommand{\cI}{{\mathcal I}}
\newcommand{\cE}{{\mathcal E}}
\newcommand{\cD}{{\mathcal D}}
%\newcommand{\cTh}{{\mathcal Th}}
\newcommand{\cS}{{\mathcal S}}
\newcommand{\cR}{{\mathcal R}}
\newcommand{\cES}{{\mathcal ES}}
\newcommand{\cN}{{\mathcal N}}
\newcommand{\cL}{{\mathcal L}}
\newcommand{\cV}{{\mathcal V}}

\newcommand{\cG}{{\mathcal G}}
\newcommand{\cW}{{\mathcal W}}
\newcommand{\bbR}{{\mathbb R}}
\newcommand{\uP}{\underline{P}}
\newcommand{\oP}{\overline{P}}

\newcommand\mydescriptionopt{
	\IEEEsetlabelwidth{$g \in \cG_{\textit{off}}^0$]}
	\IEEEusemathlabelsep
}
\begin{document}

\section{Nomenclature}

\subsection{Indices and Sets}
\begin{IEEEdescription}[\mydescriptionopt] 
	\item[$t \in \cT$] Set of hourly time steps: $1, \ldots, T$, where $T$ = {\tt number of time periods}
	\item[$m \in \cM$] Set of machines (or controllable units)
%	\item[$m \in \cP^+$] Subset of machines producing electrical power, $\subseteq \cM$
%	\item[$m \in \cQ^+$] Subset of machines producing thermal power, $\subseteq \cM$
%	\item[$m \in \cC^+$] Subset of machines producing cooling power, $\subseteq \cM$

	\item[$m \in \cF$] Subset of machines consuming external inputs (i.e. fuels), $\subseteq \cM$
	\item[$m \in \cI$] Subset of machines consuming internal inputs (i.e. electricity, heat and cooling power) produced within the MES itself, $\subseteq \cM$

	\item[$m \in \cD$] Subset of machines which can dissipate output power to ambient, $\subseteq \cM$
	
	\item[$es \in \cES$] Set of energy storage technologies
%	\item[$es \in \cES_{el}$] Subset of energy storage technologies storing electricity, $\subseteq \cES$
%	\item[$es \in \cES_{h}$] Subset of energy storage technologies storing heat, $\subseteq \cES$
	
	\item[$r \in \cR$] Set of renewable technologies (or non-controllable units)
	
	\item[$n \in \cN$] Set of external networks which can trade goods with the MES
		
	\item[$l \in \cL$] Set of loads
	
	\item[$s \in \cS$] Set of machine slots: $1, \ldots, N_{s}$, where $N_{s}$ = {\tt number of slots}
	
	\item[$v \in \cV_{m}$] Set of vertexes of the performance maps for machine $m$
	
	\item[$w \in \cW_m$] Piecewise production cost intervals for machine $m$: $1, \ldots, W_m$, where $W_m$ = {\tt 			    number of sampling sizes}

\end{IEEEdescription}

\subsection{Continuous variables}
\begin{IEEEdescription}[\mydescriptionopt]
	\item[$x_{m, s}^D$] Size of machine $m \in \cM$ installed in slot $s \in \cS$ (kW), $\in \bbR^+$
	\item[$x_{es}^{stor, D}$] Size or capacity of storage system $es \in \cES$ (kWh), $\in \bbR^+$
	\item[$x_{r}^{res, D}$] Size of the renewable technology $r \in \cR$ ($m^2$), $\in \bbR^+$
	\item[$in_{m, s, t}$] Rate power of input consumed by machine $m \in \cM$ in slot $s \in \cS$ at time $t \in \cT$ (kW), $\in \bbR^+$
	\item[$out_{m, s, g, t}$] Rate power output produced by machine $m \in \cM$ in slot $s \in \cS$ of good $g \in \cG$ at time $t \in \cT$ (kW), $\in \bbR^+$
%	\item[$el_{m, s, t}^{gen}$] Electric power generated by machine $m \in \cP^+$ in slot $s \in \cS$ at time $t \in \cT$ (kWh), $\in \bbR$
%	\item[$el_{r, t}^{gen}$] Electric power generated by renewable technology $r \in \cR$ at time $t \in \cT$ (kWh), $\in \bbR$
%	\item[$q_{m, s, t}^{gen}$] Thermal power generated by machine $m \in \cQ^+$ in slot $s \in \cS$ at time $t \in \cT$ (kWh), $\in \bbR$
%	\item[$c_{m, s, t}^{gen}$] Cooling power generated by machine $m \in \cC^+$ in slot $s \in \cS$ at time $t \in \cT$ (kWh), $\in \bbR$
	\item[$out_{m, s, g, t}^{diss}$] Rate of dissipated power output by machine $m \in \cD$ in slot $s \in \cS$ of good $g \in \cG$ at time $t \in \cT$ (kW), $\in \bbR^+$
	\item[$out_{m, s, g, t}^{us}$] Rate of useful power output by machine $m \in \cD$ in slot $s \in \cS$ of good $g \in \cG$ at time $t \in \cT$ (kW), $\in \bbR^+$
	\item[$out_{r, g, t}^{res}$] Rate power output by renewable technology $r \in \cR$ of good $g \in \cG$ at time $t \in \cT$ (kW), $\in \bbR^+$
	
	\item[$net_{n, g, t}$] Net power exchanged with the network $n \in \cN$ of good $g \in \cG$ at time $t \in \cT$ (kW), $\in \bbR$
	
	\item[$soc_{es, t}$] State of Charge of the energy storage technology $es \in \cES$ at time $t \in \cT$ (kWh), $\in \bbR^+$
	\item[$sp_{es, t}^{net}$] Net power exchange with the energy storage technology $es \in \cES$ at time $t \in \cT$ (kW), $\in \bbR$
	\item[$sp_{es, t}^{ch}$] Charge power exchange of the energy storage technology $es \in \cES$ at time $t \in \cT$ (kW), $\in \bbR^+$
	\item[$sp_{es, t}^{dish}$] Discharge power exchange of the energy storage technology $es \in \cES$ at time $t \in \cT$ (kW), $\in \bbR^+$
	
	\item[$\beta_{m, s, t, v}$] Convex hull operation control variable associated to vertex $v \in \cV$ of the performance map of machine $m \in \cM$ in site $s \in \cS$ at time $t \in \cT$ (kW), $\in \bbR^+$
	\item[$\xi_{m, s, t}$] Linearisation variable associated to the product $x_{m,s}^D \cdot z_{m,s,t}$ of machine $m \in \cM$ in site $s \in \cS$ at time $t \in \cT$ (kW), $\in \bbR^+$
	
	\item[$\gamma_{m, s, w}$] Convex hull operation control variable associated to the cost interval $w \in \cW$ of machine $m \in \cM$ in site $s \in \cS$, $\in [0,1]$
	\item[$\gamma_{es, w}^{stor}$] Convex hull operation control variable associated to the cost interval $w \in \cW$ of storage system $es \in \cES$ (-), $\in [0,1]$
	
	\item[$C_{m, s}^{inv}$] Investment cost associated to machine $m \in \cM$ in site $s \in \cS$ (\euro), $\in \bbR^+$
	\item[$C_{es}^{inv, stor}$] Investment cost associated to storage system $es \in \cES$ (\euro), $\in \bbR^+$
		
	\item[$Rev_{n, g, t}^{net}$] Net revenue (if positive) or cost (if negative) from the trade of good $g \in \cG$ with the network $n \in \cN$ at time $t \in \cT$ (\euro), $\in \bbR$

\end{IEEEdescription}


\subsection{Binary variables}
\begin{IEEEdescription}[\mydescriptionopt]
	\item[$z_{m, s}^D$] Yes/no installation of machine $m \in \cM$ in slot $s \in \cS$, $\in \{0,1\}$
	\item[$z_{es}^{stor, D}$] Yes/no installation of storage system $es \in \cES$, $\in \{0,1\}$
	
	\item[$z_{m, s, t}$] On/off status of machine $m \in \cM$ in slot $s \in \cS$ at time $t \in \cT$, $\in \{0,1\}$
	\item[$\delta_{m, s, t}^{on}$] Start-up status of machine $m \in \cM$ in slot $s \in \cS$ at time $t \in \cT$, $\in \{0,1\}$
	\item[$\delta_{m, s, t}^{off}$] Shut-down status of machine $m \in \cM$ in slot $s \in \cS$ at time $t \in \cT$, $\in \{0,1\}$
	
	\item[$s_{n, g, t}$] Binary variable to keep into account whether the good $g \in \cG$ is sold to the network $n \in \cN$ at time $t \in \cT$, $\in \{0,1\}$
	
	\item[$c_{es, t}$] Storage status variable to keep into account whether the storage system $es \in \cES$ is charging or discharging at time $t \in \cT$, $\in \{0,1\}$
	
	\item[$b_{m, s, w}$] Binary variable to activate the interval $w \in \cW$ of the investment cost of machine $m \in \cM$ in slot $s \in \cS$, $\in \{0,1\}$
	\item[$b_{m, s, w}^{stor}$] Binary variable to activate the interval $w \in \cW$ of the investment cost of storage system $es \in \cES$, $\in \{0,1\}$
	

\end{IEEEdescription}


\section{Model Description}
\subsection{Objective Function}
The objective of the Unit Commitment (UC) problem is to minimize the Total Annual Cost ($TAC=Capex \cdot ccr + Opex$). So, the objective function of the UC problem can then be written as:
{\allowdisplaybreaks
		\begin{align}
		& \text{min } \left( \Phi^{TAC} = \Phi^{Capex} \cdot ccr + \Phi^{Opex} \right)
		\label{eq:Obj_fun} %\tag{UC} %\\
		\end{align}
		where:
		\begin{align}
		& \Phi^{Capex} = \sum_{s \in \cS} \sum_{m \in \cM} C_{m,s}^{inv} +\sum_{es \in \cES} C_{es}^{inv, stor} + \sum_{r \in \cR} x_r^{res,D}\cdot \hat{c}_r^{inv}
		\label{eq:Obj_capex} %\tag{UC} %\\
		\end{align}
		\begin{align}
		\begin{split}
		& \Phi^{Opex} = \sum_{t \in \cT} \biggl( \sum_{m \in \cF} \sum_{s \in \cS} f_{m,s,t}\cdot \hat{c}_{m}^{fuel} + \sum_{m \in \cM} \sum_{s \in \cS} z_{m,s,t} \cdot \hat{c}_{m}^{O\&M} \\ 
		& \qquad \qquad + \sum_{r \in \cR} x_r^D \cdot \hat{c}_r^{O\&M}  + \sum_{m \in \cF} \sum_{s \in \cS} \delta_{m,s,t}^{on} \cdot \hat{c}_m^{fuel} \cdot SU_{m}^{cost} \biggr)
		\label{eq:Obj_opex} %\tag{UC} %\\
		\end{split}		
		\end{align}

\subsection{Investment Constraints}
The maximum number of machines that can be installed in a single slot is equal to one, as expressed by~\eqref{eq:Installation_1}. If a machine is not installed, it should be always off~\eqref{eq:Installation_2} and finally the constraint~\eqref{eq:Installation_3} imposes a rule on the slots filling order to avoid any symmetry in the MILP formulation. 
		\begin{align}
		& \sum_{m \in \cM} z_{m,s}^{D} \leq 1 & \hspace{10cm} \forall s \in \cS \label{eq:Installation_1}\\
		& z_{m,s,t} \leq z_{m,s}^D & \hspace{8cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Installation_2}\\
		& z_{m,s+1}^D \leq z_{m,s}^D & \hspace{8cm} \forall s \geq m \quad m \in \cM \quad \forall s \in \cS \label{eq:Installation_3}
		\end{align}
The constraints below ensures that the size $x_{m,s,t}^D$ of machine $m$ installed in site $s$ is bounded between the minimum and the maximum available sizes ($\hat{X}_{m}^{D, max}$ and $\hat{X}_{m}^{D, min}$). The same holds for the sizes of the energy storage technologies $es \in \cES$ and for the total installed area $x_r^D$ of renewable technology $r$ which is limited as well by the total area available ($\hat{A}_{r}^{max}$).

		\begin{align}
		& z_{m,s}^D \cdot \hat{X}_{m}^{D, min} \leq x_{m,s}^D \leq z_{m,s}^D \cdot \hat{X}_{m}^{D, max} &\hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \label{eq:Size_lim} \\
		& z_{es}^{stor,D} \cdot \hat{X}_{es}^{D, min} \leq x_{es}^{stor,D} \leq z_{es}^{stor,D} \cdot \hat{X}_{es}^{D, max} & \forall es \in \cES \label{eq:Size_stor_max} \\
		& x_r^{res, D} \leq \hat{A}_r^{max} & \forall r \in \cR \label{eq:MaxArea_available}
		\end{align}
In order to include the size effect on the investment costs, a piece-wise approximation of the exponential economy of scale law has been adopted in the MILP formulation. The investment cost function $C_{m,s}^{inv}$ for machine $m$ installed in site $s$ is approximated by the convex combination of the cost function evaluated at the extremes of the piece-wise interval corresponding to the machine size ($C_{m}^{inv}(X_{m,k}^D)$ and $C_{m}^{inv}(X_{m,k+1}^D)$). 
The linearisation bin is activated by the binary variable $b_{m,s,w}$ while the variable $\gamma_{m,s,w} \in [0,1]$ is used to express the convex combination relationship in~\eqref{eq:Convex_xD} and~\eqref{eq:Convex_Cinv}. 
At borders of the interpolations intervals $b_{m,s,w}$ takes the value of zero. Constraint~\eqref{eq:Gamma_b_link} imposes that the only $\gamma_{m,s,w}$ values different from zero can be $\gamma_{m,s,k}$ and $\gamma_{m,s,k+1}$. As usual, constraints~\eqref{eq:Active_b} and~\eqref{eq:Active_gamma} are necessary to activate these constrains only if the machines $m$ is installed in site $s$. For the energy storage technologies $es \in \cES$, analogous constraints are considered. 
		\begin{align}
		& \sum_{ k = 0 }^{N-1} b_{m,s,k} = z_{m,s}^D & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \label{eq:Active_b}\\
		& \gamma_{m,s,w} \leq b_{m,s,w-1} + b_{m,s,w}  & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall w \in \cW_m \label{eq:Gamma_b_link}\\
		& \gamma_{m,s,0} \leq b_{m,s,0}  & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \label{eq:Gamma_b_zero}\\
		& \gamma_{m,s,N} \leq b_{m,s,N-1}  & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \label{eq:Gamma_b_n}\\
		& \sum_{k \in \cW_m} \gamma_{m,s,k} = z_{m,s}^D & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \label{eq:Active_gamma}\\
		& x_{m,s}^D = \sum_{k \in \cW_m} \gamma_{m,s,k} \cdot \hat{X}_{m,k}^D & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \label{eq:Convex_xD}\\
		& C_{m,s}^{inv} = \sum_{k \in \cW_m} \gamma_{m,s,k} \cdot C_{m}^{inv}(\hat{X}_{m,k}^D) & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \label{eq:Convex_Cinv}
		\end{align}				

\subsection{Operation Constraints}
The demand-production balance for each good $g \in \cG$ is enforced at each timestep by the equation~\eqref{eq:En_balance}. Note that the useful rate power is defined~\eqref{eq:En_diss} as the output power, relative to good $g \in \cG$, which is generated but not dissipated by machine $m$ in site $s$. 		
		\begin{align}
		\begin{split}
		& \sum_{m \in \cM} \sum_{s \in \cS} out_{m,s,g,t} - \sum_{m \in \cI} \sum_{s \in \cS} in_{m,s,t} - \sum_{m \in \cD} out_{m,s,g,t}^{diss} \\ 
		& + \sum_{r \in \cR} out_{r,g,t}^{res}  + \sum_{es \in \cES} sp_{es,t}^{net} + \sum_{n \in \cN} net_{n,g,t} = \sum_{l \in \cL_g} \hat{L}_{l,g,t}  \hspace{4cm} \forall g \in \cG \quad \forall t \in \cT \label{eq:En_balance}
		\end{split}		
		\end{align}
		where:
		\begin{align}
		& out_{m,s,g,t}^{diss} = out_{m,s,g,t}  - out_{m,s,g,t}^{us} & \hspace{4cm} \forall m \in \cD \quad \forall s \in \cS \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:En_diss}
		\end{align}
		while the power output from non-controllable units is defined at each timestep by their generation profile ($\hat{out}_{r,g,t}^{res}$):
		\begin{align}
		& out_{r,g,t}^{res} = \hat{out}_{r,g,t}^{res}& \hspace{4cm} \forall r \in \cR \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:En_res}
		\end{align}
Even in this case to simulate the part load performance a convex combination is used. In particular the operating point of the machine $m$ in  site $s$ at time $t$ is computed as the convex combination of the vertexes of its feasible operational region.  
Two variables are used to perform the convex combination: $\beta_{m,s,t,v}$ and $\xi_{m,s,t}$ corresponding to $x_{m,s}^D$ when the machine is on. The set of constraints is the follow: 		
		\begin{align}
		& \xi_{m,s,t} \ge\ \sum_{v \in \cV_m} \beta_{m,s,t,v} & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Xi_beta_link}\\
		& \xi_{m,s,t} \leq z_{m,s,t} \cdot \hat{X}_{m}^{D,max} & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Xi_active1}\\
		& \xi_{m,s,t} \leq x_{m,s}^D & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Xi_active2}\\
		& \xi_{m,s,t} \geq x_{m,s}^D - (1-z_{m,s,t}) \cdot \hat{X}_{m}^{D,max} & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Xi_active3}
		\end{align}	
Thanks to the above described formulation, all the variable related to machines inputs and outputs can be defined (only one-degree of freedom units are considered):
		\begin{align}
		& in_{m,s,t} = \hat{K}_{m,0}^{IN} \cdot \xi_{m,s,t} + \sum_{v \geq 1} \beta_{m,s,t,v} \cdot (\hat{K}_{m,v}^{IN} - \hat{K}_{m,0}^{IN} ) & \hspace{3cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:in}
		\end{align}
		\begin{align}
		\begin{split}
		& out_{m,s,g,t} =  \xi_{m,s,t} \cdot \left( \hat{K}_{m,0}^{IN} \cdot \hat{K}_{m}^{1P} + \hat{K}_{m}^{2P} \right) + \sum_{v \geq 1} \beta_{m,s,t,v} \cdot (\hat{K}_{m,v}^{IN} - \hat{K}_{m,0}^{IN}) \cdot \hat{K}_{m}^{1P} \\ & \qquad \qquad \quad + \hat{K}_{m}^{3P} \cdot z_{m,s,t} \hspace{6cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:out}\\
		\end{split}		
		\end{align}
		\begin{comment}
		\begin{align}
		& q_{m,s,t}^{gen} = \xi_{m,s,t} \cdot \left( \hat{K}_{m,0}^{IN} \cdot \hat{K}_{m}^{1Q} + \hat{K}_{m}^{2Q} \right) + \sum_{v \geq 1} \beta_{m,s,t,v} \cdot (\hat{K}_{m,v}^{IN} - \hat{K}_{m,0}^{IN}) \cdot \hat{K}_{m}^{1Q} + \hat{K}_{m}^{3Q} \cdot z_{m,s,t} &\forall m \in \cQ^+ \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:heat_gen}\\
		& c_{m,s,t}^{gen} = \xi_{m,s,t} \cdot \left( \hat{K}_{m,0}^{IN} \cdot \hat{K}_{m}^{1C} + \hat{K}_{m}^{2C} \right) + \sum_{v \geq 1} \beta_{m,s,t,v} \cdot (\hat{K}_{m,v}^{IN} - \hat{K}_{m,0}^{IN}) \cdot \hat{K}_{m}^{1C} + \hat{K}_{m}^{3C} \cdot z_{m,s,t} &\forall m \in \cC^+ \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:cold_gen}
		\end{align}	
		\end{comment}			
The technical limit regarding the single machine operation has now to be introduced. Fist the max/min power input depends on the machine size ($\hat{K}_{m,min}^{IN}$ and $\hat{K}_{m,max}^{IN}$):
		\begin{align}
	& \xi_{m,s,t} \cdot \hat{K}_{m,min}^{IN} \leq in_{m,s,t} \leq \xi_{m,s,t} \cdot \hat{K}_{m,max}^{IN} & \hspace{4cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:In_lim}
		\end{align}
		\begin{comment}
		\begin{align}
	& f_{m,s,t} \geq \xi_{m,s,t} \cdot \hat{K}_{m,min}^{IN} & \hspace{7cm} \forall m \in \cF \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Min_fuel}\\
	& f_{m,s,t} \leq \xi_{m,s,t} \cdot \hat{K}_{m,max}^{IN} &\forall m \in \cF \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Max_fuel}\\
	& el_{m,s,t}^{cons} \geq \xi_{m,s,t} \cdot \hat{K}_{m,min}^{IN} & \forall m \in \cF \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Min_el}\\
	& el_{m,s,t}^{cons} \leq \xi_{m,s,t} \cdot \hat{K}_{m,max}^{IN} & \forall m \in \cF \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:Max_el}
		\end{align}
		\end{comment}
Secondly, the constrain on the maximum rump up and rump down limit should be respected, expressed as variation of the power in input. Constraints~\eqref{eq:RUlim} and~\eqref{eq:RDlim} include also limitation on the maximum power at the start up and shut down operation of the machines. 
		\begin{align}
		& (in_{m,s,t} - in_{m,s,t-1}) \leq  z_{m, s, t-1} \cdot \hat{ru}_{m}^{lim} + \hat{in}_{m}^{max, SU} \cdot (1-z_{m,s,t-1}) & \hspace{0cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:RUlim}\\
		& (in_{m,s,t} - in_{m,s,t-1}) \geq -z_{m,s,t} \cdot \hat{rd}_{m}^{lim} - \hat{in}_{m}^{max, SD} \cdot (1-z_{m,s,t}) & \hspace{0cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:RDlim}
		\end{align}
\begin{comment} 	
		\begin{align}
		& (f_{m,s,t} - f_{m,s,t-1}) \leq \hat{f}_{m}^{RU,lim} & \hspace{5cm} \forall m \in \cF \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:RUlim_f}\\
		& (f_{m,s,t-1} - f_{m,s,t}) \leq \hat{f}_{m}^{RD,lim} & \hspace{5cm} \forall m \in \cF \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:RDlim_f}\\
		& (el_{m,s,t}^{cons} - el_{m,s,t-1}^{cons}) \leq \hat{el}_{m}^{RU,lim} & \hspace{5cm} \forall m \in \cP^- \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:RUlim_el}\\
		& (el_{m,s,t-1}^{cons} - el_{m,s,t}^{cons}) \leq \hat{el}_{m}^{RD,lim} & \hspace{5cm} \forall m \in \cP^- \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:RDlim_el}
		\end{align}	
\end{comment}
The set of constraints here above is used to establish if machine $m$ in slot $s$ has been switched on or off at time $t$. 
		\begin{align}
		& (z_{m,s,t}-z_{m,s,t-1}) \leq \delta_{m,s,t}^{on} \leq \frac{z_{m,s,t}-z_{m,s,t-1} +1}{2} & \hspace{2cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:DeltaOn}\\
		& (z_{m,s,t-1}-z_{m,s,t}) \leq \delta_{m,s,t}^{off} \leq \frac{z_{m,s,t-1}-z_{m,s,t} +1}{2} & \hspace{2cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:DeltaOff}
		\end{align}		 	
\begin{comment}		
		\begin{align}
		& \Delta_{m,s,t}^{on} \geq (z_{m,s,t} - z_{m,s,t-1}) & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:DeltaOn_1}\\
		& \Delta_{m,s,t}^{on} \leq (1 - z_{m,s,t-1}) & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:DeltaOn_2}\\
		& \Delta_{m,s,t}^{on} \leq z_{m,s,t} & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:DeltaOn_3}\\
		& \Delta_{m,s,t}^{off} \geq (z_{m,s,t-1} - z_{m,s,t}) & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:DeltaOff_1}\\
		& \Delta_{m,s,t}^{off} \leq (1 - z_{m,s,t}) & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:DeltaOff_2}\\
		& \Delta_{m,s,t}^{off} \leq z_{m,s,t-1} & \hspace{5cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \setminus\{1\} \in \cT \label{eq:DeltaOff_3}
		\end{align}
\end{comment}
These variable are important in order to account for the cost of an extra energy in input when the machines is turned on but mostly to write down constraints~\eqref{eq:MinUT} and~\eqref{eq:MinDT} regarding the minimum up and down time respectively.	
		\begin{align}
		& \sum_{ i = t - \hat{t}_{min, UT} }^{t} z_{m,s,i} \geq \hat{t}_{min,UT} \cdot \delta_{m,s,t}^{off} & \hspace{3cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \geq \hat{t}_{min, UT} \in \cT \label{eq:MinUT}\\
		& \sum_{ i = t - \hat{t}_{min, DT} }^{t} z_{m,s,i} \geq \hat{t}_{min,DT} \cdot \delta_{m,s,t}^{on} & \forall m \in \cM \quad \forall s \in \cS \quad \forall t \geq \hat{t}_{min, DT} \in \cT \label{eq:MinDT}
		\end{align}
Equation~\eqref{eq:Soc} express the storage management constraint which defines, at each time-step, the power entering ($sp_{es,t}^{ch}$) and exiting ($sp_{es,t}^{disch}$) the energy storage system with the corresponding input/output efficiencies ($\hat{\eta}_{es}^{ch}$ and $\hat{\eta}_{es}^{disch}$) for each $es \in \cES$. To consider the hourly loss inside the storage system the self-discharge parameter $\hat{\lambda}_{es}$ has been also introduced. 
The level or State of Charge (SoC) of the energy stored in the storage system should not overcame the storage capacity which is given by the variable denoting its size ($x_{es}^{stor, D}$) for each $es \in \cES$ and also the power input and output should fall into a defined range~\eqref{eq:Stor_capacity}, as stated by equations~\eqref{eq:Stor_maxCharge} and~\eqref{eq:Stor_maxDisch}. A storage status variable $s_{es,t}$ has been introduced to prevent charge/discharge components to be different from zero at the same time. 
Finally the level of the storage is conserved by fixing the storage level at time $T$ to be equal to the storage level at the beginning of the period ($\hat{L}_{es}^{stor,0}$). 
		\begin{align}
		& soc_{es,t} = soc_{es,t-1} \cdot (1-\hat{\lambda}_{es}) + (sp_{es,t}^{ch} - sp_{es,t}^{disch}) \cdot \hat{\Delta t}  & \hspace{4cm} \forall es \in \cES \quad \forall t \in \cT \label{eq:Soc}\\
		& sp_{es,t}^{net} = sp_{es,t}^{ch} \cdot \hat{\eta}_{es}^{ch} - \frac{sp_{es,t}^{disch}}{\hat{\eta}_{es}^{disch}} & \hspace{4cm} \forall es \in \cES \quad \forall t \in \cT \label{eq:sp_net}\\
		& soc_{es,t} \leq x_{es}^{stor, D} &\hspace{1cm} \forall es \in \cES \quad \forall t \in \cT \label{eq:Stor_capacity}\\
		& sp_{es,t}^{ch} \leq \hat{P}_{es}^{max, charge} \cdot c_{es,t} & \forall es \in \cES \quad \forall t \setminus\{1\} \in \cT \label{eq:Stor_maxCharge}\\
		& sp_{es,t}^{disch} \leq \hat{P}_{es}^{max, disch} \cdot (1-c_{es,t}) & \forall es \in \cES \quad \forall t \setminus\{1\} \in \cT \label{eq:Stor_maxDisch}\\
		& soc_{es,0} = \hat{L}_{es}^{stor,0} \cdot x_{es}^{stor, D} &\forall es \in \cES \label{eq: Stor_init}\\
		& soc_{es,0} = soc_{es, T} &\forall es \in \cES \label{eq:Stor_boundaries}
		\end{align}
\begin{comment}
		\begin{align}
		& l_{es,t}^{stor} - l_{es,t-1}^{stor} \cdot (1-\hat{\lambda}_{es}) = l_{es,t}^{charge} \cdot \hat{\eta}_{es}^{ch} - l_{es,t}^{disch} \cdot \frac{1}{\hat{\eta}_{es}^{disch}}  & \hspace{4cm} \forall es \in \cES \quad \forall t \in \cT \label{eq:Stor_level}\\
		& l_{es,t}^{stor} \leq x_{es}^{stor, D} &\hspace{1cm} \forall es \in \cES \quad \forall t \in \cT \label{eq:Stor_capacity}\\
		& l_{es,t}^{charge} \leq \hat{P}_{es}^{max, charge} \cdot \Delta t & \forall es \in \cES \quad \forall t \setminus\{1\} \in \cT \label{eq:Stor_maxCharge}\\
		& l_{es,t}^{disch} \leq \hat{P}_{es}^{max, disch} \cdot \Delta t & \forall es \in \cES \quad \forall t \setminus\{1\} \in \cT \label{eq:Stor_maxDisch}\\
		& l_{es,0}^{stor} = \hat{L}_{es}^{stor,0} \cdot x_{es}^{stor, D} &\forall es \in \cES \label{eq: Stor_init}\\
		& l_{es,0}^{stor} = l_{es, T}^{stor} &\forall es \in \cES \label{eq:Stor_boundaries}
		\end{align}
\end{comment}
Since goods traded with networks connected to the MES can be either sold or purchased from the grid at two different prices, the binary variable $s_{n,g,t}$ is used as a flag to denote if the good $n \in \cN$ is flowing into the network hub $n \in \cN$ or it's withdraw from it. The amount of energy purchased or sold is stored in the real variable $s_{n,g,t}$ which can take values either positive or negative. 
The variable $Rev_{n,g,t}^{net}$ takes into account the cost of energy sold/purchased in the objective function and it's assume positive values when the good is sold and negative values when bought from the network. In modeling following set of constrain a standard "big M" formulation was adopted.  
		\begin{align}
		& net_{n,g,t} \geq (s_{n,g,t} - 1) \cdot M_{4}& \hspace{4cm} \forall n \in \cN \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:Net_1}\\
		& net_{n,g,t} \leq s_{n,g,t} \cdot M_{3} & \forall n \in \cN \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:Net_2}\\
		& Rev_{n,g,t}^{net} \leq net_{n,g,t} \cdot \hat{c}_{n,g,t}^{sold} \cdot \hat{\Delta t} + (1-s_{n,g,t}) \cdot M_{1}&\forall n \in \cN \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:Net_3}\\
		& Rev_{n,g,t}^{net} \leq net_{n,g,t} \cdot \hat{c}_{n,g,t}^{purch} \cdot \hat{\Delta t} + s_{n,g,t} \cdot M_{2} &\forall n \in \cN \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:Net_4}
		\end{align}
		where: 
		\begin{align}
		& M_{1} = M_{4} \cdot \hat{c}_{n,g,t}^{purch} & \hspace{5cm} \forall n \in \cN \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:M1}\\
		& M_{2} = M_{3} \cdot \hat{c}_{n,g,t}^{sold} &\forall n \in \cN \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:M2}\\
		& M_{3} = \left( \sum_{m \in \cM} \sum_{s \in \cS} \hat{out}_{m,s,g}^{max} \right) \cdot 1.5 & \forall n \in \cN \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:M3}\\
		& M_{4} = \left( \hat{L}_{l,g}^{max} + \sum_{m \in \cI} \sum_{s \in \cS} \hat{in}_{m,s}^{max} \right) \cdot 1.5 & \forall n \in \cN \quad \forall g \in \cG \quad \forall t \in \cT \label{eq:M4}
		\end{align}	
\begin{comment}
		\begin{align}
		& el_{t}^{grid} \geq (s_{t} - 1) \cdot M_{4, t}& \hspace{8cm} \forall t \in \cT \label{eq:Elgrid_1}\\
		& el_{t}^{grid} \leq s_{t} \cdot M_{3, t}& \hspace{8cm} \forall t \in \cT \label{eq:Elgrid_2}\\
		& El_{t}^{grid} \leq el_{t}^{grid} \cdot \hat{c}_{t}^{el,sold} + (1-s_t) \cdot M_{1, t}& \hspace{5cm} \forall t \in \cT \label{eq:Elgrid_3}\\
		& El_{t}^{grid} \leq el_{t}^{grid} \cdot \hat{c}_{t}^{el,purch} + s_t \cdot M_{2, t}& \hspace{5cm} \forall t \in \cT \label{eq:Elgrid_4}
		\end{align}
		where: 
		\begin{align}
		& M_{1,t} = M_{4,t} \cdot \hat{c}_{t}^{el,purch} \hspace{11cm} \forall t \in \cT \label{eq:M1}\\
		& M_{2,t} = M_{3,t} \cdot \hat{c}_{t}^{el,sold} \hspace{11cm} \forall t \in \cT \label{eq:M2}\\
		& M_{3,t} = \left( \sum_{m \in \cP^+} \sum_{s \in \cS} \hat{el}_{m,s,t}^{max, gen} \right) \cdot 1.5 \hspace{9cm} \forall t \in \cT \label{eq:M3}\\
		& M_{4,t} = \left( \hat{El}_t^{demand} + \sum_{m \in \cP^-} \sum_{s \in \cS} \hat{el}_{m,s,t}^{max, cons} \right) \cdot 1.5 \hspace{7cm} \forall t \in \cT \label{eq:M4}
		\end{align}
\end{comment}
The parameters $\hat{out}_{m,s,g,t}^{max}$ and $\hat{in}_{m,s,t}^{max}$ represent the maximum power that can be respectively generated or consumed by machine $m$ in slot $s$ at time $t$. 


\subsection{Convex Hull formulation}
In the problem statement a set of two coefficients has been used to linearise the correlation between the size and the minimum-maximum load range ($\hat{K}_{m,0}^{IN}$ and $\hat{K}_{m,1}^{IN}$) representing respectively the minimum ($v=0=min$) and the maximum ($v=1=max$) input as a fraction of the machine size.
A set of three coefficient, instead, has been used to linearise the input-output correlations of each machine and to model the size and load effect on machines efficiency ($\hat{K}_{m}^{1}$, $\hat{K}_{m}^{2}$ and $\hat{K}_{m}^{3}$). 
With these parameters the convex hull formulation for an internal combustion engine becomes: 
		\begin{align}
		& \hat{K}_{m,0}^{IN} \cdot x_{m,s}^{D} \cdot z_{m,s,t} \leq f_{m,s,t} \leq \hat{K}_{m,1}^{IN} \cdot x_{m,s}^D \cdot z_{m,s,t} & \hspace{2cm} \forall m \in \cF \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:fuel_limit_ICE}\\
		& f_{m,s,t} = \sum_{v \in \cV_m} \alpha_{m,s,t,v} \cdot x_{m,s}^D \cdot \hat{K}_{m,v}^{IN} & \forall m \in \cF \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:fuel_in_ICE}\\
		& el_{m,s,t}^{gen} = \hat{K}_{m}^{1P} \cdot f_{m,s,t} + \hat{K}_{m}^{2P} \cdot x_{m,s}^{D} \cdot z_{m,s,t} + \hat{K}_{m}^{3P} \cdot z_{m,s,t} & \forall m \in \cP^+ \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:el_gen_ICE}\\
		& q_{m,s,t}^{gen} = \hat{K}_{m}^{1Q} \cdot f_{m,s,t} + \hat{K}_{m}^{2Q} \cdot x_{m,s}^{D} \cdot z_{m,s,t} + \hat{K}_{m}^{3Q} \cdot z_{m,s,t} &\forall m \in \cQ^+ \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:heat_gen_ICE}
		\end{align}		
where $\alpha_{m,s,t,v}$ is the control variable of the convex hull formulation and thus the following property holds: $\sum_{v \in \cV_m} \alpha_{m,s,t,v} = 1$. In order to activate the constraint on the convex hull control operation variable, the following formulation is adopted: 
\begin{align}
&\sum_{v \in \cV_m} \alpha_{m,s,t,v} = z_{m,s,t} & \hspace{7cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:alpha_ICE} 
\end{align}
Now substituting equation~\eqref{eq:fuel_in_ICE} and equation~\eqref{eq:alpha_ICE} in equations~\eqref{eq:el_gen_ICE}, we obtain two new expression for the electricity generated by the ICE (the same holds for the heat generated):
		\begin{align}
		& el_{m,s,t}^{gen} = \sum_{v \in \cV_m} \alpha_{m,s,t,v} \cdot x_{m,s}^D \cdot (\hat{K}_{m,0}^{IN} \cdot \hat{K}_{m}^{1P} + \hat{K}_{m}^{2P} ) + \hat{K}_{m}^{3P} \cdot z_{m,s,t} & \hspace{1cm} \forall m \in \cP^+ \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:el_gen_ICE_2}
		\end{align}
Using the linearisation variable $\beta_{m,s,t,v} = \alpha_{m,s,t,v} \cdot x_{m,s}^D$ constrains~\eqref{eq:alpha_ICE} and~\eqref{eq:el_gen_ICE_2} become:
		\begin{align}
		&\sum_{v \in \cV_m} \beta_{m,s,t,v} = \xi_{m,s,t} & \hspace{2cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:xi_ICE} \\
		& el_{m,s,t}^{gen} = \sum_{v \in \cV_m} \beta_{m,s,t,v} \cdot (\hat{K}_{m,0}^{IN} \cdot \hat{K}_{m}^{1P} + \hat{K}_{m}^{2P} ) + \hat{K}_{m}^{3P} \cdot z_{m,s,t} & \hspace{1cm} \forall m \in \cP^+ \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:el_gen_ICE_3}
		\end{align}
where $\xi_{m,s,t}= z_{m,s,t} \cdot x_{m,s}^D$.


\subsection{Convex Hull formulation with (n-1) control operation variables}

The convex hull formulation explained above can be re-written in a smarter way that allows us to save one control operation variable and thus reducing the computational time to find the solutions. According to this idea, an alternative expression for the equation~\eqref{eq:fuel_in_ICE} is the following: 
\begin{align}
& f_{m,s,t} = \hat{K}_{m,0}^{IN} \cdot x_{m,s}^D \cdot z_{m,s,t} + \sum_{v \geq 1} \alpha_{m,s,t,v} \cdot x_{m,s}^D \cdot (\hat{K}_{m,v}^{IN}-\hat{K}_{m,0}^{IN}) & \hspace{1cm} \forall m \in \cF \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:fuel_in_ICE_new}
\end{align}
or equivalently using $\beta_{m,s,t,v}$ and $\xi_{m,s,t}$:
\begin{align}
& f_{m,s,t} = \hat{K}_{m,0}^{IN} \cdot \xi_{m,s,t} + \sum_{v \geq 1} \beta_{m,s,t,v} \cdot (\hat{K}_{m,v}^{IN}-\hat{K}_{m,0}^{IN}) & \hspace{2cm} \forall m \in \cF \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:fuel_in_ICE_new_2}
\end{align}
Unlikely the previous formulation, the constraint on the convex hull operation control variable ($\alpha_{m,s,t,v}$ or $\beta_{m,s,t,v}$) is not anymore represented by a strict equality but it turns into an inequality constraint:
\begin{align}
&\sum_{v \in \cV_m} \alpha_{m,s,t,v} \leq z_{m,s,t} & \hspace{2cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:alpha_ICE_new}
\end{align}
or 
\begin{align}
&\sum_{v \in \cV_m} \beta_{m,s,t,v} \leq \xi_{m,s,t} & \hspace{2cm} \forall m \in \cM \quad \forall s \in \cS \quad \forall t \in \cT \label{eq:xi_ICE_new}
\end{align} 
With this new formulation also the equations related to the output of the machine should be re-written. As before this is done replacing the fuel term in the equation expressing the output generated (ex. electricity): 
\begin{equation}
\begin{split}
&el_{m,s,t}^{gen} = \hat{K}_{m}^{1P} \cdot \left( \hat{K}_{m,0}^{IN} \cdot x_{m,s}^D \cdot z_{m,s,t} + \sum_{v \geq 1} \alpha_{m,s,t,v} \cdot x_{m,s}^D \cdot (\hat{K}_{m,v}^{IN}-\hat{K}_{m,0}^{IN}) \right) \hspace{5cm} \\ & \qquad \qquad + \hat{K}_{m}^{2P} \cdot x_{m,s}^{D} \cdot z_{m,s,t} + \hat{K}_{m}^{3P} \cdot z_{m,s,t}
\end{split}
\end{equation}
and re-arranging the terms and using the linearisation variables we have: 
\begin{align}
& el_{m,s,t}^{gen} = \xi_{m,s,t} \cdot \left( \hat{K}_{m,0}^{IN} \cdot \hat{K}_{m}^{1P} + \hat{K}_{m}^{2P} \right) + \sum_{v \geq 1} \beta_{m,s,t,v} \cdot (\hat{K}_{m,v}^{IN} - \hat{K}_{m,0}^{IN}) \cdot \hat{K}_{m}^{1P} + \hat{K}_{m}^{3P} \cdot z_{m,s,t} \hspace{1cm} \label{eq:el_gen_new}
\end{align}
This idea can be generalized to all other inputs and outputs belonging to different types of machines. 





%% add the bibtex
\begin{filecontents*}{MODEL.bib}
@article{morales2013tight,
	title={Tight and compact {MILP} formulation for the thermal unit commitment problem},
	author={Morales-Espa{\~n}a, G. and Latorre, J. M. and Ramos, A.},
	journal={IEEE Transactions on Power Systems},
	volume={28},
	number={4},
	pages={4897--4908},
	year={2013},
	publisher={IEEE}
}
@article{sridhar2013locally,
	title={Locally ideal formulations for piecewise linear functions with indicator variables},
	author={Sridhar, Srikrishna and Linderoth, Jeff and Luedtke, James},
	journal={Operations Research Letters},
	volume={41},
	number={6},
	pages={627--632},
	year={2013},
	publisher={Elsevier}
}
\end{filecontents*}
\bibliographystyle{acm}
\bibliography{MODEL}	
\end{document}